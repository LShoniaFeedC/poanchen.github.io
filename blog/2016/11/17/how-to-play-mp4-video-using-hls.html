<!DOCTYPE html>
<html>

<head>
  <title>How to play mp4 video using hls.js?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="/app/css/index.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/monokai-sublime.min.css">
</head>

<body>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="https://www.linkedin.com/in/poan-baron-chen-a00aa655" target="_blank">CV</a></li>
      <li><a href="/contact">Contact</a></li>
      <li><a href="/blog">Blog</a></li>
    </ul>
  </nav>
  <div class="container">
    <h1>How to play mp4 video using hls.js?</h1>
<p class="meta">
   
    Posted by <a href="https://github.com/poanchen" target="_blank">PoAn (Baron) Chen</a> on 17 Nov 2016
  
</p>

<div class="post">
  <p>Today, I am going to show you guys how to play mp4 video using <a href="https://github.com/dailymotion/hls.js/tree/master">hls.js</a>. hls.js is a JavaScript library which implements a HTTP Live Streaming client. It relies on HTML5 video and MediaSource Extensions for playback. What is great about hls.js is that it does not need any player, it works directly on top of a standard HTML &lt;video&gt; element. (assuming your browser supported it, check <a href="http://caniuse.com/#search=MediaSource">here</a>). So, how does hls.js works? It works by breaking the overall stream into a sequence of small HTTP-based file downloads, each download loading one short chunk of an overall stream. As the stream is played, it will continue on requesting more short chunk of the overall stream. And, how does it know what file name it should download? Since, initially, the video will be load from a m3u8 file where it contains the metadata of the video itself. You may think it as a playlist. By simply looking at them, hls.js would know which file should download next while playing. Couple of the advantages of using HLS is that it works faster than <a href="http://www.adobe.com/ca/products/flashplayer.html">Flash</a>, it is supported by <a href="http://caniuse.com/#search=MediaSource">many browser</a> these days, and it unlocks the potential to stream live in 4k and 60 fps. This is an example of how a m3u8 file would look like.</p>

<h2 id="sample-m3u8-file-when-the-video-is-named-samplemp4">sample m3u8 file when the video is named sample.mp4</h2>

<pre>
  <code class="java">
    #EXTM3U
    #EXT-X-VERSION:3
    #EXT-X-TARGETDURATION:11
    #EXT-X-MEDIA-SEQUENCE:0
    #EXTINF:10.023222,
    sample0.ts
    #EXTINF:10.000000,
    sample1.ts
    #EXTINF:10.000000,
    sample2.ts
    #EXTINF:10.000000,
    sample3.ts
    #EXTINF:10.000000,
    sample4.ts
    #EXTINF:10.000000,
    sample5.ts
    #EXTINF:10.000000,
    sample6.ts
    #EXTINF:10.000000,
    sample7.ts
    #EXTINF:10.000000,
    sample8.ts
    #EXTINF:7.800000,
    sample9.ts
    #EXT-X-ENDLIST
  </code>
</pre>
<p>As you can see, the first chunk of the overall stream is sample0.ts and follow by sample1.ts. In this way, hls.js would know which ts file to be played next. Now, before we dive right into the code. We first need to convert the mp4 video to m3u8 format in order to use the HLS technologies. There are many great tools that can do this. We are going to use the <a href="https://linux.die.net/man/1/ffmpeg">command line with ffmpeg</a> by <a href="https://www.ffmpeg.org/">ffmpeg</a>. And, I will be using ffmpeg in command line to convert the video from mp4 to m3u8. If you do not have ffmpeg installed, please go to this StackOverflow <a href="http://stackoverflow.com/questions/29125229/how-to-reinstall-ffmpeg-clean-on-ubuntu-14-04">thread</a> for more instruction on how to install on Ubuntu. Say, I have a mp4 video file named sample.mp4 and I would like to name my m3u8 file as sample.m3u8. Then, I may simply do this command to convert the mp4 video to m3u8 format.</p>

<h2 id="command-on-how-to-convert-mp4-video-to-m3u8-format-using-ffmpeg">command on how to convert mp4 video to m3u8 format using ffmpeg</h2>

<pre>
  <code class="bash">
    ffmpeg -i sample.mp4 -profile:v baseline -level 3.0 -s 840x560 -start_number 0 -hls_list_size 0 -f hls sample.m3u8
  </code>
</pre>
<p>Notice that I set the resolution of video to 840x560. Please refer to this <a href="https://linux.die.net/man/1/ffmpeg">site</a> if you are interested in other size. When you hit the ENTER button, it should begin for conversion and it might look something similar like this.</p>

<p><img src="/img/2016/11/17/how-to-play-mp4-video-using-hls/Converting to m3u8 from mp4.PNG" alt="Converting to m3u8 from mp4" /></p>

<p>Wait for it to be finished (it might take some time depends on the size of your video and machine specs). When it is done, you should see bunch of ts file like sample0.ts, sample1.ts, and sample.m3u8. This means that you have successfully convert your mp4 file to m3u8 format. Now, when we have all these. We can dive right into how to use hls.js to play m3u8 file. We first need to include the hls.js from the CDN.</p>

<h2 id="including-hlsjs-library-code-from-jsdelivr-cdn">Including hls.js library code from jsdelivr CDN</h2>

<pre>
  <code class="html">
    &lt;script src="//cdn.jsdelivr.net/hls.js/latest/hls.min.js"&gt;&lt;/script&gt;
  </code>
</pre>
<p>Now, we need to add the &lt;div&gt; element with video as id so that the JavaScript would know where to put the video.</p>

<h2 id="adding-div-element-with-video-as-id-with-controls">Adding div element with video as id with controls</h2>

<pre>
  <code class="html">
    &lt;video id="video" controls&gt;&lt;/video&gt;
  </code>
</pre>
<p>Then, we need to write the JavaScript code that use the hls.js library to play the video.</p>

<h2 id="play-m3u8-playlist-using-hlsjs-library">Play m3u8 playlist using hls.js library</h2>

<pre>
  <code class="html">
    &lt;script type="text/javascript"&gt;
      var video = document.getElementById("video");
      var videoSrcHls = "https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/sample.m3u8";

      if(Hls.isSupported()) {
        var hls = new Hls();
        hls.loadSource(videoSrcHls);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function() {
          video.play();
        });
      }
    &lt;/script&gt;
  </code>
</pre>
<p>In the code, we first check if the browser is HLS supported, then we initialize the Hls instance, and load it with the path where you put your m3u8 file. Later, we simply play the video. So that, when user comes to the site, the video will be automatically played. However, what happen when the browser does not support HLS? We should do this as fallback as it is a good practice.</p>

<h2 id="added-the-fallback-when-users-browser-does-not-support-hls">Added the fallback when user’s browser does not support HLS</h2>

<pre>
  <code class="html">
    &lt;script type="text/javascript"&gt;
      var video = document.getElementById("video");
      var videoSrcInHls = "https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/sample.m3u8";
      var videoSrcInMp4 = "https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/sample.mp4";

      if(Hls.isSupported()) {
        var hls = new Hls();
        hls.loadSource(videoSrcInHls);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function() {
          video.play();
        });
      }else{
        addSourceToVideo(video, videoSrcInMp4, 'video/mp4');
        video.play();
      }

      function addSourceToVideo(element, src, type) {
        var source = document.createElement('source');
        source.src = src;
        source.type = type;
        element.appendChild(source);
      }
    &lt;/script&gt;
  </code>
</pre>
<p>Now, even if the browser happen to not support hls, user may still be able to watch the video. If you would like to see the live demo, please visit <a href="https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/playM3u8UsingHlsJs.html">here</a>.</p>

<h2 id="full-code-for-playm3u8usinghlsjshtml-nbspnbspa-hrefhttpsgithubcompoanchencode-for-blogblobmaster20161117how-to-play-mp4-video-using-hlsplaym3u8usinghlsjshtml-targetblanksource-codea">Full code for playM3u8UsingHlsJs.html   <a href="https://github.com/poanchen/code-for-blog/blob/master/2016/11/17/how-to-play-mp4-video-using-hls/playM3u8UsingHlsJs.html" target="_blank">source code</a></h2>

<pre>
  <code class="html">
    &lt;script src="//cdn.jsdelivr.net/hls.js/latest/hls.min.js"&gt;&lt;/script&gt;
    &lt;video id="video" controls&gt;&lt;/video&gt;

    &lt;script type="text/javascript"&gt;
      var video = document.getElementById("video");
      var videoSrcInHls = "https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/sample.m3u8";
      var videoSrcInMp4 = "https://www.jenrenalcare.com/upload/poanchen.github.io/sample-code/2016/11/17/how-to-play-mp4-video-using-hls/sample.mp4";

      if(Hls.isSupported()) {
        var hls = new Hls();
        hls.loadSource(videoSrcInHls);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function() {
          video.play();
        });
      }else{
        addSourceToVideo(video, videoSrcInMp4, 'video/mp4');
        video.play();
      }

      function addSourceToVideo(element, src, type) {
        var source = document.createElement('source');
        source.src = src;
        source.type = type;
        element.appendChild(source);
      }
    &lt;/script&gt;
  </code>
</pre>

<h2 id="wrapping-up">Wrapping Up</h2>

<p>Hopefully this guide has given you the confidence to play around with hls.js. I hope that this tutorial has helped you and thank you for reading!</p>

<h2 id="resources">Resources</h2>

<p>I’ll try to keep this list current and up to date. If you know of a great resource you’d like to share or notice a broken link, please <a href="https://github.com/poanchen">get in touch</a>.</p>

<h3 id="getting-started">Getting started</h3>

<ul>
  <li><a href="http://ffmpeg.org/ffmpeg-all.html#hls">ffmpeg command option reference1</a> by <a href="http://ffmpeg.org/">ffmpeg</a>.</li>
  <li><a href="https://linux.die.net/man/1/ffmpeg">ffmpeg command option reference2</a>.</li>
  <li><a href="http://stackoverflow.com/questions/30912542/mp4-to-hls-using-ffmpeg">ffmpeg command help</a> by <a href="http://stackoverflow.com/users/2489973/budthapa">budthapa</a>.</li>
  <li><a href="https://en.wikipedia.org/wiki/HTTP_Live_Streaming">HTTP Live Streaming</a>.</li>
  <li><a href="http://blog.peer5.com/http-live-streaming-in-javascript/">HTTP Live Streaming In Javascript</a> by <a href="http://blog.peer5.com/author/shachar-zohar/">Shachar Zohar</a>.</li>
</ul>

</div>

<div id="disqus_thread"></div>
<script src="/app/js/disqus.min.js"></script>
<noscript>
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  </div>
  <footer>
  <ul>
    <li><a href="mailto:chen.baron@hotmail.com">email</a></li>
    <li><a href="https://github.com/poanchen">github.com/poanchen</a></li>
    <li><a href="https://www.linkedin.com/in/poan-baron-chen-a00aa655">linkedin.com/in/poan-baron-chen-a00aa655</a></li>
  </ul>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script src="/app/js/googleAnalytics.min.js"></script>
</body>

</html>